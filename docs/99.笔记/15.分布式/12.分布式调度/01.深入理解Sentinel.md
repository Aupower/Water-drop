---
title: 《深入理解 Sentinel》笔记
order: 1
categories:
  - 笔记
  - 分布式
  - 分布式调度
tags:
  - 分布式
  - 调度
  - 限流
  - 熔断
  - 降级
  - Sentinel
date: 2024-05-27 06:58:23
permalink: /pages/58f34d/
---

# 《深入理解 Sentinel》笔记

## 开篇词：一次服务雪崩问题排查经历

> **什么是服务雪崩**

**服务雪崩**是指：在微服务项目中指由于突发流量导致某个服务不可用，从而导致上游服务不可用，并产生级联效应，最终导致整个系统不可用。

当一切正常时，整体系统如下所示：

![](https://raw.githubusercontent.com/dunwu/images/master/snap/202401280931974.png)

在分布式系统架构下，这些强依赖的子服务稳定与否对系统的影响非常大。但是，依赖的子服务可能有很多不可控问题：如网络连接、资源繁忙、服务宕机等。例如：下图中有一个 QPS 为 50 的依赖服务 I 出现不可用，但是其他依赖服务是可用的。

![](https://raw.githubusercontent.com/dunwu/images/master/snap/202401280931939.png)

当流量很大的情况下，某个依赖的阻塞，会导致上游服务请求被阻塞。当这种级联故障愈演愈烈，就可能造成整个线上服务不可用的雪崩效应，如下图。这种情况若持续恶化，如果上游服务本身还被其他服务所依赖，就可能出现多米洛骨牌效应，导致多个服务都无法正常工作。

![img](https://github.com/Netflix/Hystrix/wiki/images/soa-3-640.png)

## 为什么需要服务降级以及常见的几种降级方式

服务降级是为了保障服务能够稳定运行的一种保护方式，应对流量突增用降级牺牲一些流量换取系统的稳定。常见的服务降级实现方式有：开关降级、限流降级、熔断降级。

限流降级与熔断降级都可以实现在消费端限流或者服务端限流，限流可以根据流量控制策略处理超过阈值的流量。

- 限流即便没有达到系统的瓶颈，只要流量达到设定的阈值，就会触发限流；
- 熔断尽最大的可能去完成所有的请求，容忍一些失败，熔断也能自动恢复。熔断的常见降级策略：
  - 在每秒请求异常数超过多少时触发熔断降级
  - 在每秒请求异常错误率超过多少时触发熔断降级
  - 在每秒请求平均耗时超过多少时触发熔断降级

开关降级适用于促销活动这种可以明确预估到并发会突增的场景。

## 为什么选择 Sentinel，Sentinel 与 Hystrix 的对比

|                | Sentinel                                       | Hystrix                       |
| :------------- | :--------------------------------------------- | :---------------------------- |
| 社区活跃度     | Github 13K star                                | 官方停止维护                  |
| 隔离策略       | 信号量隔离                                     | 线程池隔离/信号量隔离         |
| 熔断降级策略   | 基于响应时间或失败比率                         | 基于失败比率                  |
| 实时指标实现   | 滑动窗口                                       | 滑动窗口（基于 RxJava）       |
| 规则配置       | 支持多种数据源                                 | 支持多种数据源                |
| 扩展性         | 多个 SPI 扩展点                                | 插件的形式                    |
| 基于注解的支持 | 支持                                           | 支持                          |
| 限流           | 基于 QPS，支持基于调用关系的限流               | 有限的支持                    |
| 流量整形       | 支持慢启动、匀速器模式                         | 不支持                        |
| 系统负载保护   | 支持                                           | 不支持                        |
| 控制台         | 开箱即用，可配置规则、查看秒级监控、机器发现等 | 不完善                        |
| 常见框架的适配 | Servlet、Spring Cloud、Dubbo、gRPC 等          | Servlet、Spring Cloud Netflix |

## Sentinel 基于滑动窗口的实时指标数据统计

- WindowWrap 用于包装 Bucket，随着 Bucket 一起创建。
- WindowWrap 数组实现滑动窗口，Bucket 只负责统计各项指标数据，WindowWrap 用于记录 Bucket 的时间窗口信息。
- 定位 Bucket 实际上是定位 WindowWrap，拿到 WindowWrap 就能拿到 Bucket。

## Sentinel 的一些概念与核心类介绍

- 资源：资源是 Sentinel 的关键概念。资源，可以是一个方法、一段代码、由应用提供的接口，或者由应用调用其它应用的接口。
- 规则：围绕资源的实时状态设定的规则，包括流量控制规则、熔断降级规则以及系统保护规则、自定义规则。
- 降级：在流量剧增的情况下，为保证系统能够正常运行，根据资源的实时状态、访问流量以及系统负载有策略的拒绝掉一部分流量。

## Sentinel 中的责任链模式与 Sentinel 的整体工作流程

## 07 Java SPI 及 SPI 在 Sentinel 中的应用

## 08 资源指标数据统计的实现全解析（上）

## 09 资源指标数据统计的实现全解析（下）

## 10 限流降级与流量效果控制器（上）

## 11 限流降级与流量效果控制器（中）

## 12 限流降级与流量效果控制器（下）

## 13 熔断降级与系统自适应限流

## 14 黑白名单限流与热点参数限流

## 15 自定义 ProcessorSlot 实现开关降级

## 16 Sentinel 动态数据源：规则动态配置

## 17 Sentinel 主流框架适配

## 18 Sentinel 集群限流的实现（上）

## 19 Sentinel 集群限流的实现（下）

## 20 结束语：Sentinel 对应用的性能影响如何？

## 21 番外篇：Sentinel 1.8.0 熔断降级新特性解读
